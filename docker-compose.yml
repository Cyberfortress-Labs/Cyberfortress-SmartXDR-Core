services:
  # Nginx - Reverse Proxy (HTTPS)
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    image: smartxdr-nginx:dev
    container_name: smartxdr-nginx
    ports:
      - "${NGINX_HTTPS_PORT:-8443}:8443"
      - "${NGINX_HTTP_PORT:-8080}:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/certs:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      api:
        condition: service_started
    networks:
      - smartxdr-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # SmartXDR API Service
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: wanthinnn/smartxdr-core:dev
    container_name: smartxdr-core
    environment:
      - FLASK_ENV=production
      - DEBUG=false
      - API_AUTH_ENABLED=true
      - TELEGRAM_BOT_ENABLED=${TELEGRAM_BOT_ENABLED:-true}
      - ELASTICSEARCH_ENABLED=${ELASTICSEARCH_ENABLED:-true}
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
    env_file:
      - .env
    depends_on:
      chromadb:
        condition: service_started
    volumes:
      # Persistent data - bind mount to preserve data on host
      - ./data:/app/data
      - ./logs:/app/logs
      # Read-only configs
      - ./certs:/app/certs:ro
      - ./prompts:/app/prompts:ro
      - ./assets:/app/assets:ro
      - ./sources_config:/app/sources_config:ro
    networks:
      - smartxdr-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ChromaDB Vector Database Service
  chromadb:
    image: chromadb/chroma:latest
    container_name: smartxdr-chromadb
    ports:
      - "${CHROMA_PORT:-8000}:8000"  # ChromaDB API
    volumes:
      # Mount to /data (ChromaDB's default persist path)
      - ${CHROMA_DB_SOURCE:-chroma-db}:/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - smartxdr-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/heartbeat')"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: smartxdr-cloudflared
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared:/etc/cloudflared:ro
    depends_on:
      nginx:
        condition: service_healthy
    networks:
      - smartxdr-net



networks:
  smartxdr-net:
    driver: bridge
    name: smartxdr-network

volumes:
  # Vector embeddings database
  chroma-db:
    driver: local
    name: smartxdr-chroma-db
  
  # Nginx logs
  nginx-logs:
    driver: local
    name: smartxdr-nginx-logs
