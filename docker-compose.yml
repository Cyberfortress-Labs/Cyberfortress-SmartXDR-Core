services:
  # Nginx - Reverse Proxy (HTTPS)
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: smartxdr-nginx
    ports:
      - "${NGINX_HTTPS_PORT:-8443}:8443"
      - "${NGINX_HTTP_PORT:-8080}:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/certs:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      api:
        condition: service_started
    networks:
      - smartxdr-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # SmartXDR API Service
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: smartxdr-core
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - DEBUG=${DEBUG:-false}
      - API_AUTH_ENABLED=${API_AUTH_ENABLED:-true}
      - TELEGRAM_BOT_ENABLED=${TELEGRAM_BOT_ENABLED:-true}
      - ELASTICSEARCH_ENABLED=${ELASTICSEARCH_ENABLED:-true}
      - CHROMA_HOST=${CHROMA_DATA_HOST:-chromadb-data}
      - CHROMA_PORT=${CHROMA_PORT:-8000}
      - CHROMA_CONV_HOST=${CHROMA_CONV_HOST:-chromadb-conv}
      - CHROMA_CONV_PORT=${CHROMA_CONV_PORT:-8000}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    env_file:
      - .env
    depends_on:
      chromadb-data:
        condition: service_started
      chromadb-conv:
        condition: service_started
    volumes:
      # Database directory - bind mount to preserve data on host
      - smartxdr-core-data:/app/db/app_data
      - ./logs:/app/logs
      # Read-only configs
      - ./certs:/app/certs:ro
      - ./prompts:/app/prompts:ro
      - ./assets:/app/assets:ro
      - ./sources_config:/app/sources_config:ro
      # Development: mount scripts and app for live reload
      - ./scripts:/app/scripts:ro
      - ./app:/app/app:ro
      - ./gunicorn.conf.py:/app/gunicorn.conf.py:ro
      - huggingface-cache:/home/smartxdr/.cache/huggingface
    networks:
      - smartxdr-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G

  # ChromaDB Vector Database Service (RAG Knowledge Base)
  chromadb-data:
    image: chromadb/chroma:latest
    container_name: smartxdr-chromadb-data
    ports:
      - "${CHROMA_DATA_EXTERNAL_PORT:-8000}:8000" # ChromaDB API
    volumes:
      # Mount to /data (ChromaDB's default persist path)
      - ${CHROMA_DB_SOURCE:-chroma-db}:/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - smartxdr-net
    restart: unless-stopped
    # Health check using bash /dev/tcp (from ChromaDB cookbook)
    healthcheck:
      test: [ "CMD", "/bin/bash", "-c", "cat < /dev/null > /dev/tcp/localhost/8000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ChromaDB for Conversation History (separate instance)
  chromadb-conv:
    image: chromadb/chroma:latest
    container_name: smartxdr-chromadb-conv
    ports:
      - "${CHROMA_CONV_EXTERNAL_PORT:-8001}:8000" # Different external port
    volumes:
      - chroma-conv:/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - smartxdr-net
    restart: unless-stopped
    # Health check using bash /dev/tcp (from ChromaDB cookbook)
    healthcheck:
      test: [ "CMD", "/bin/bash", "-c", "cat < /dev/null > /dev/tcp/localhost/8000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Redis Cache for Conversation Memory
  redis:
    image: redis:7-alpine
    container_name: smartxdr-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - smartxdr-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: smartxdr-cloudflared
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared:/etc/cloudflared:ro
    depends_on:
      nginx:
        condition: service_healthy
    networks:
      - smartxdr-net

networks:
  smartxdr-net:
    driver: bridge
    name: smartxdr-network

volumes:
  # Vector embeddings database (RAG)
  chroma-db:
    driver: local
    name: smartxdr-chroma-db

  # Conversation history database
  chroma-conv:
    driver: local
    name: smartxdr-chroma-conv

  # Redis cache data
  redis-data:
    driver: local
    name: smartxdr-redis-data

  # Nginx logs
  nginx-logs:
    driver: local
    name: smartxdr-nginx-logs

  # SmartXDR Core data
  smartxdr-core-data:
    driver: local
    name: smartxdr-core-data

  # Hugging Face Model Cache
  huggingface-cache:
    driver: local
    name: smartxdr-huggingface-cache
