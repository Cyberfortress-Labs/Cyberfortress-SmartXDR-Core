#!/bin/bash

# SmartXDR Core - Deployment Script
# Usage: ./start [--prod] <command>

set -e

# Default to development
ENV="dev"
COMPOSE_FILE="docker-compose.yml"

# Parse environment flag
if [[ "$1" == "--prod" ]]; then
    ENV="prod"
    COMPOSE_FILE="docker-compose.prod.yml"
    shift
fi

# Get command
COMMAND="${1:-help}"

# Color output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

printf "${BLUE}[SmartXDR - ${ENV}]${NC} Running: ${GREEN}${COMMAND}${NC}\n"

case "$COMMAND" in
    setup)
        printf "${YELLOW}Setting up environment...${NC}\n"
        
        mkdir -p data chroma_db logs certs nginx/conf.d
        
        if [ ! -f .env ]; then
            if [ -f .env.example ]; then
                cp .env.example .env
                printf "${YELLOW}Created .env from .env.example${NC}\n"
                printf "${RED}Please edit .env with your API keys!${NC}\n"
            else
                printf "${RED}Error: .env file not found!${NC}\n"
                exit 1
            fi
        fi
        
        printf "${GREEN}Setup complete${NC}\n"
        ;;
    
    build)
        printf "${YELLOW}Building Docker images...${NC}\n"
        DOCKER_BUILDKIT=1 docker compose -f "$COMPOSE_FILE" build
        printf "${GREEN}Build complete${NC}\n"
        ;;
    
    up|start)
        printf "${YELLOW}Starting SmartXDR services...${NC}\n"
        
        # Check for local chroma_db and set environment variable
        if [ -d "chroma_db" ] && [ -n "$(ls -A chroma_db 2>/dev/null)" ]; then
            printf "${GREEN}✓ Found local chroma_db - mounting as volume${NC}\n"
            export CHROMA_DB_SOURCE="./chroma_db"
        else
            printf "${YELLOW}⚠ No local chroma_db found - using Docker volume${NC}\n"
            if [ "$ENV" = "prod" ]; then
                printf "${YELLOW}  RAG will start empty. Ingest documents after deployment.${NC}\n"
            fi
            export CHROMA_DB_SOURCE="chroma-db"
        fi
        
        docker compose -f "$COMPOSE_FILE" up -d
        printf "\n"
        printf "${GREEN}Services started successfully!${NC}\n"
        printf "  API:    ${BLUE}http://localhost:8080${NC}\n"
        printf "  HTTPS:  ${BLUE}https://localhost:8443${NC}\n"
        printf "  Logs:   ${YELLOW}./start logs${NC}\n"
        printf "  Manage: ${YELLOW}./start manage${NC}\n"
        
        if [ "$CHROMA_DB_SOURCE" = "chroma-db" ]; then
            printf "\n"
            printf "${BLUE}ℹ To ingest documents: ${YELLOW}./start quick_rag <path>${NC}\n"
        fi
        ;;
    
    down|stop)
        printf "${YELLOW}Stopping services...${NC}\n"
        docker compose -f "$COMPOSE_FILE" down
        printf "${GREEN}Services stopped${NC}\n"
        ;;
    
    restart)
        printf "${YELLOW}Restarting services...${NC}\n"
        docker compose -f "$COMPOSE_FILE" restart
        printf "${GREEN}Services restarted${NC}\n"
        ;;
    
    logs)
        SERVICE="${2:-}"
        if [ -z "$SERVICE" ]; then
            docker compose -f "$COMPOSE_FILE" logs -f --tail=100
        else
            docker compose -f "$COMPOSE_FILE" logs -f --tail=100 "$SERVICE"
        fi
        ;;
    
    ps|status)
        docker compose -f "$COMPOSE_FILE" ps
        ;;
    
    shell)
        printf "${BLUE}Opening shell in API container...${NC}\n"
        docker compose -f "$COMPOSE_FILE" exec api /bin/bash
        ;;
    
    manage)
        printf "${BLUE}Opening SmartXDR Manager...${NC}\n"
        docker compose -f "$COMPOSE_FILE" exec api python scripts/smartxdr_manager.py
        ;;
    
    health)
        printf "${YELLOW}Checking service health...${NC}\n"
        curl -s http://localhost:8080/health | python -m json.tool 2>/dev/null || printf "API not responding\n"
        ;;
    
    quick_rag)
        DOCS_PATH="${2:-assets}"
        printf "${BLUE}Running Quick RAG Ingestion...${NC}\n"
        printf "  Documents path: ${DOCS_PATH}\n"
        docker compose -f "$COMPOSE_FILE" exec api python scripts/quick_rag_docs.py --path "${DOCS_PATH}"
        ;;
    
    sync_rag)
        printf "${BLUE}RAG Database Management:${NC}\n"
        printf "\n"
        printf "  ${GREEN}1. Mount existing DB:${NC}\n"
        printf "     Place chroma_db/ in project root → ./start restart\n"
        printf "\n"
        printf "  ${GREEN}2. Ingest documents:${NC}\n"
        printf "     ./start quick_rag <path>\n"
        printf "\n"
        printf "  ${GREEN}3. Restore backup:${NC}\n"
        printf "     tar xzf backup/chroma.tar.gz -C . && ./start restart\n"
        ;;
    
    clean)
        printf "${RED}Removing all containers and volumes...${NC}\n"
        read -p "Are you sure? This will delete all data! (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            docker compose -f "$COMPOSE_FILE" down -v
            printf "${GREEN}Cleaned up${NC}\n"
        else
            printf "${YELLOW}Cancelled${NC}\n"
        fi
        ;;
    
    rebuild)
        printf "${YELLOW}Rebuilding from scratch...${NC}\n"
        docker compose -f "$COMPOSE_FILE" down
        docker compose -f "$COMPOSE_FILE" build --no-cache
        docker compose -f "$COMPOSE_FILE" up -d
        printf "${GREEN}Rebuild complete${NC}\n"
        ;;
    
    pull)
        printf "${YELLOW}Pulling latest images...${NC}\n"
        docker compose -f "$COMPOSE_FILE" pull
        printf "${GREEN}Pull complete${NC}\n"
        ;;
    
    update)
        printf "${YELLOW}Updating SmartXDR...${NC}\n"
        docker compose -f "$COMPOSE_FILE" pull
        docker compose -f "$COMPOSE_FILE" up -d
        printf "${GREEN}Update complete${NC}\n"
        ;;
    
    backup)
        BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
        mkdir -p "$BACKUP_DIR"
        printf "${YELLOW}Backing up data to ${BACKUP_DIR}...${NC}\n"
        
        docker run --rm \
            -v smartxdr-core-data:/data:ro \
            -v "$(pwd)/$BACKUP_DIR":/backup \
            alpine tar czf /backup/data.tar.gz -C /data .
        
        docker run --rm \
            -v smartxdr-chroma-db:/data:ro \
            -v "$(pwd)/$BACKUP_DIR":/backup \
            alpine tar czf /backup/chroma.tar.gz -C /data .
        
        printf "${GREEN}Backup complete: ${BACKUP_DIR}${NC}\n"
        ;;
    
    help|--help|-h)
        printf "${BLUE}SmartXDR Core - Deployment Script${NC}\n"
        printf "\n"
        printf "Usage: ./start [--prod] <command>\n"
        printf "\n"
        printf "Environment:\n"
        printf "  ${GREEN}--prod${NC}      Use production configuration\n"
        printf "  ${GREEN}(default)${NC}   Use development configuration\n"
        printf "\n"
        printf "Commands:\n"
        printf "  ${GREEN}setup${NC}       Initial setup (directories, .env)\n"
        printf "  ${GREEN}build${NC}       Build Docker images\n"
        printf "  ${GREEN}start${NC}       Start all services\n"
        printf "  ${GREEN}stop${NC}        Stop all services\n"
        printf "  ${GREEN}restart${NC}     Restart all services\n"
        printf "  ${GREEN}logs${NC}        View service logs (./start logs [service])\n"
        printf "  ${GREEN}status${NC}      Show service status\n"
        printf "  ${GREEN}shell${NC}       Open shell in API container\n"
        printf "  ${GREEN}manage${NC}      Open SmartXDR Manager CLI\n"
        printf "  ${GREEN}health${NC}      Check API health\n"
        printf "  ${GREEN}quick_rag${NC}   Ingest documents to RAG (./start quick_rag [path])\n"
        printf "  ${GREEN}sync_rag${NC}    Copy local chroma_db to container\n"
        printf "  ${GREEN}clean${NC}       Remove containers and volumes\n"
        printf "  ${GREEN}rebuild${NC}     Rebuild from scratch\n"
        printf "  ${GREEN}pull${NC}        Pull latest images\n"
        printf "  ${GREEN}update${NC}      Pull and restart services\n"
        printf "  ${GREEN}backup${NC}      Backup data and embeddings\n"
        printf "  ${GREEN}help${NC}        Show this help\n"
        printf "\n"
        printf "Examples:\n"
        printf "  ${YELLOW}# Quick start${NC}\n"
        printf "  ./start setup\n"
        printf "  ./start build\n"
        printf "  ./start start\n"
        printf "  ./start manage    # Create admin and API keys\n"
        printf "\n"
        printf "  ${YELLOW}# Production${NC}\n"
        printf "  ./start --prod pull\n"
        printf "  ./start --prod start\n"
        printf "\n"
        printf "  ${YELLOW}# Maintenance${NC}\n"
        printf "  ./start logs api\n"
        printf "  ./start backup\n"
        printf "\n"
        printf "Access URLs:\n"
        printf "  HTTP:  ${BLUE}http://localhost:8080${NC}\n"
        printf "  HTTPS: ${BLUE}https://localhost:8443${NC}\n"
        ;;
    
    *)
        printf "${RED}Unknown command: $COMMAND${NC}\n"
        printf "Run './start help' for usage information\n"
        exit 1
        ;;
esac