#!/bin/bash

# SmartXDR - Deployment Script
# Usage: ./start [--prod] [command]

set -e

# Default to development
ENV="dev"
COMPOSE_FILE="docker-compose.yml"

# Parse environment flag
if [[ "$1" == "--prod" ]]; then
    ENV="prod"
    COMPOSE_FILE="docker-compose.prod.yml"
    shift
fi

# Get command
COMMAND="${1:-help}"

# Color output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}[SmartXDR - ${ENV}]${NC} Running: ${GREEN}${COMMAND}${NC}"

case "$COMMAND" in
    setup)
        echo -e "${YELLOW}Setting up environment...${NC}"
        # Create required directories
        mkdir -p data chroma_db logs certs
        
        # Check .env file
        if [ ! -f .env ]; then
            echo -e "${RED}Error: .env file not found!${NC}"
            echo "Please create .env file with required configurations"
            exit 1
        fi
        
        echo -e "${GREEN}✓ Setup complete${NC}"
        ;;
    
    build)
        echo -e "${YELLOW}Building Docker images...${NC}"
        # Enable BuildKit for faster builds with cache
        DOCKER_BUILDKIT=1 docker compose -f "$COMPOSE_FILE" build
        ;;
    
    up|start)
        echo -e "${YELLOW}Starting SmartXDR services...${NC}"
        docker compose -f "$COMPOSE_FILE" up -d
        echo ""
        echo -e "${GREEN}✓ Services started successfully!${NC}"
        echo -e "  API:   ${BLUE}https://localhost:8443${NC}"
        echo -e "  HTTP:  ${BLUE}http://localhost:8080${NC}"
        echo -e "  Logs:  ${YELLOW}./start logs${NC}"
        ;;
    
    down|stop)
        echo -e "${YELLOW}Stopping services...${NC}"
        docker compose -f "$COMPOSE_FILE" down
        echo -e "${GREEN}✓ Services stopped${NC}"
        ;;
    
    restart)
        echo -e "${YELLOW}Restarting services...${NC}"
        docker compose -f "$COMPOSE_FILE" restart
        echo -e "${GREEN}✓ Services restarted${NC}"
        ;;
    
    logs)
        docker compose -f "$COMPOSE_FILE" logs -f --tail=100
        ;;
    
    ps|status)
        docker compose -f "$COMPOSE_FILE" ps
        ;;
    
    shell)
        echo -e "${BLUE}Opening shell in API container...${NC}"
        docker compose -f "$COMPOSE_FILE" exec api /bin/bash
        ;;
    
    api-key)
        shift
        echo -e "${BLUE}Managing API keys...${NC}"
        docker compose -f "$COMPOSE_FILE" exec api python scripts/manage_api_keys.py "$@"
        ;;
    
    clean)
        echo -e "${RED}Removing all containers and volumes...${NC}"
        read -p "Are you sure? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            docker compose -f "$COMPOSE_FILE" down -v
            docker system prune -f
            echo -e "${GREEN}✓ Cleaned up${NC}"
        fi
        ;;
    
    rebuild)
        echo -e "${YELLOW}Rebuilding from scratch...${NC}"
        docker compose -f "$COMPOSE_FILE" down
        docker compose -f "$COMPOSE_FILE" build --no-cache
        docker compose -f "$COMPOSE_FILE" up -d
        echo -e "${GREEN}✓ Rebuild complete${NC}"
        ;;
    
    pull)
        echo -e "${YELLOW}Pulling latest images...${NC}"
        docker compose -f "$COMPOSE_FILE" pull
        ;;
    
    backup)
        BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
        mkdir -p "$BACKUP_DIR"
        echo -e "${YELLOW}Backing up data to ${BACKUP_DIR}...${NC}"
        docker compose -f "$COMPOSE_FILE" exec api tar czf - /app/data /app/chroma_db > "$BACKUP_DIR/smartxdr-backup.tar.gz"
        echo -e "${GREEN}✓ Backup complete${NC}"
        ;;
    
    help|*)
        echo -e "${BLUE}SmartXDR Deployment Script${NC}"
        echo ""
        echo "Usage: ./start [--prod] [command]"
        echo ""
        echo "Environment:"
        echo "  ${GREEN}--prod${NC}      - Use production configuration (docker-compose.prod.yml)"
        echo "  ${GREEN}(default)${NC}   - Use development configuration (docker-compose.yml)"
        echo ""
        echo "Commands:"
        echo "  ${GREEN}setup${NC}       - Initial setup (create directories, check config)"
        echo "  ${GREEN}build${NC}       - Build Docker images (dev only)"
        echo "  ${GREEN}start${NC}       - Start all services"
        echo "  ${GREEN}stop${NC}        - Stop all services"
        echo "  ${GREEN}restart${NC}     - Restart all services"
        echo "  ${GREEN}logs${NC}        - View service logs"
        echo "  ${GREEN}status${NC}      - Show service status"
        echo "  ${GREEN}shell${NC}       - Open shell in API container"
        echo "  ${GREEN}api-key${NC}     - Manage API keys (./start api-key create --name ...)"
        echo "  ${GREEN}clean${NC}       - Remove all containers and volumes"
        echo "  ${GREEN}rebuild${NC}     - Rebuild from scratch"
        echo "  ${GREEN}pull${NC}        - Pull latest images from registry"
        echo "  ${GREEN}backup${NC}      - Backup data and embeddings"
        echo "  ${GREEN}help${NC}        - Show this help"
        echo ""
        echo "Examples:"
        echo "  ${YELLOW}# Development${NC}"
        echo "  ${YELLOW}./start setup${NC}"
        echo "  ${YELLOW}./start build${NC}"
        echo "  ${YELLOW}./start start${NC}"
        echo ""
        echo "  ${YELLOW}# Production (uses DockerHub images)${NC}"
        echo "  ${YELLOW}./start --prod pull${NC}"
        echo "  ${YELLOW}./start --prod start${NC}"
        echo ""
        echo "  ${YELLOW}# Management${NC}"
        echo "  ${YELLOW}./start api-key create --name \"master\" --permissions \"*\"${NC}"
        echo "  ${YELLOW}./start logs${NC}"
        echo ""
        echo "Access URLs:"
        echo "  HTTPS: ${BLUE}https://localhost:8443${NC}"
        echo "  HTTP:  ${BLUE}http://localhost:8080${NC} ${YELLOW}(redirects to HTTPS)${NC}"
        ;;
esac

    help|--help|-h|"")
        echo "Library Management System - Deployment Script"
        echo ""
        echo "Usage: ./start [--prod|--dev] <command>"
        echo ""
        echo "Environment flags:"
        echo "  --dev           Use development environment (default)"
        echo "  --prod          Use production environment"
        echo ""
        echo "Commands:"
        echo "  setup           Initial setup (certificates, .env)"
        echo "  build           Build Docker images"
        echo "  up, start       Start all services"
        echo "  down, stop      Stop all services"
        echo "  restart         Restart all services"
        echo "  logs            View logs"
        echo "  makemigrations  Create new migrations"
        echo "  migrate         Run database migrations"
        echo "  initdata        Initialize sample data"
        echo "  createsuperuser Create Django superuser"
        echo "  shell           Open Django shell"
        echo "  collectstatic   Collect static files"
        echo "  clean           Remove containers and volumes"
        echo "  rebuild         Clean rebuild"
        echo "  help            Show this help"
        echo ""
        echo "Examples:"
        echo "  ./start build                 # Build development"
        echo "  ./start --prod build          # Build production"
        echo "  ./start --prod up             # Start production"
        echo "  ./start --dev migrate         # Run dev migrations"
        echo "  ./start logs                  # View dev logs"
        echo ""
        ;;
    
    *)
        echo -e "${YELLOW}Unknown command: $COMMAND${NC}"
        echo "Run './start help' for usage information"
        exit 1
        ;;
esac